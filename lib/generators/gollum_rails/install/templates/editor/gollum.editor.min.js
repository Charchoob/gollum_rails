(function(e){var t={MarkupType:"markdown",EditorMode:"code",NewFile:false,HasFunctionBar:true,Debug:false,NoDefinitionsFor:[]};var n={};e.GollumEditor=function(o){n=e.extend(t,o);r("GollumEditor loading");if(s.baseEditorMarkup()){if(s.titleDisplayed()){e("#gollum-editor-title-field").addClass("active")}if(s.editSummaryMarkup()){e.GollumEditor.Placeholder.add(e("#gollum-editor-edit-summary input"));e('#gollum-editor form[name="gollum-editor"]').submit(function(t){t.preventDefault();r("submitting");e(this).unbind("submit");e(this).submit()})}if(s.collapsibleInputs()){e("#gollum-editor .collapsed a.button, "+"#gollum-editor .expanded a.button").click(function(t){t.preventDefault();e(this).parent().toggleClass("expanded");e(this).parent().toggleClass("collapsed")})}if(s.previewButton()){var a=e("#gollum-editor #gollum-editor-preview").click(function(){var t=e("#gollum-editor form").attr("action");var n=e(e("#gollum-editor form").get(0));n.attr("action",this.href||"/preview");n.attr("target","_blank");var r=window.location.pathname.split("/");n.attr("page",r[r.length-1]||"");n.submit();n.attr("action",t);n.removeAttr("target");return false})}if(s.functionBar()){var f=e("#gollum-editor-body").attr("data-markup-lang");if(f){n.MarkupType=f}i.setActiveLanguage(n.MarkupType);if(s.formatSelector()){u.init(e("#gollum-editor-format-selector select"))}if(s.help()){e("#gollum-editor-help").hide();e("#gollum-editor-help").removeClass("jaws")}}}};e.GollumEditor.defineLanguage=function(e,t){if(typeof t=="object"){i.define(e,t)}else{r("GollumEditor.defineLanguage: definition for "+e+" is not an object")}};var r=function(e){if(n.Debug&&typeof console!="undefined"){console.log(e)}};var i={_ACTIVE_LANG:"",_LOADED_LANGS:[],_LANG:{},define:function(t,n){i._ACTIVE_LANG=t;i._LOADED_LANGS.push(t);if(typeof e.GollumEditor.WikiLanguage=="object"){var r={};e.extend(r,e.GollumEditor.WikiLanguage,n);i._LANG[t]=r}else{i._LANG[t]=n}},getActiveLanguage:function(){return i._ACTIVE_LANG},setActiveLanguage:function(t){if(i._ACTIVE_LANG!=null&&i._ACTIVE_LANG.length<=0){u.updateCommitMessage(t)}if(i.getHookFunctionFor("deactivate")){i.getHookFunctionFor("deactivate")()}if(!i.isLoadedFor(t)){i._ACTIVE_LANG=null;i.loadFor(t,function(n,a){function f(e,t){e.preventDefault();var n=i.getDefinitionFor(t);if(typeof n=="object"){o.executeAction(n)}return false}if(a!="success"){r("Failed to load language definition for "+t);i.define(t,{})}if(s.functionBar()){o.refresh()}if(i.isValid()&&s.formatSelector()){u.updateSelected()}if(i.getHookFunctionFor("activate")){i.getHookFunctionFor("activate")()}Mousetrap.bind(["command+1","ctrl+1"],function(e){f(e,"function-h1")});Mousetrap.bind(["command+2","ctrl+2"],function(e){f(e,"function-h2")});Mousetrap.bind(["command+3","ctrl+3"],function(e){f(e,"function-h3")});Mousetrap.bind(["command+b","ctrl+b"],function(e){f(e,"function-bold")});Mousetrap.bind(["command+i","ctrl+i"],function(e){f(e,"function-italic")});Mousetrap.bind(["command+s","ctrl+s"],function(t){t.preventDefault();e("#gollum-editor-submit").trigger("click");return false})})}else{i._ACTIVE_LANG=t;o.refresh();if(i.getHookFunctionFor("activate")){i.getHookFunctionFor("activate")()}}},getHookFunctionFor:function(e,t){if(!t){t=i._ACTIVE_LANG}if(i.isLoadedFor(t)&&i._LANG[t][e]&&typeof i._LANG[t][e]=="function"){return i._LANG[t][e]}return null},getDefinitionFor:function(e,t){if(!t){t=i._ACTIVE_LANG}if(i.isLoadedFor(t)&&i._LANG[t][e]&&typeof i._LANG[t][e]=="object"){return i._LANG[t][e]}return null},loadFor:function(t,r){if(n.NoDefinitionsFor.length){for(var i=0;i<n.NoDefinitionsFor.length;i++){if(t==n.NoDefinitionsFor[i]){if(typeof r=="function"){r(null,"error");return}}}}var s=baseUrl+"/javascript/editor/langs/"+t+".js";e.ajax({url:s,dataType:"script",complete:function(e,t){if(typeof r=="function"){r(e,t)}}})},isLoadedFor:function(e){if(i._LOADED_LANGS.length===0){return false}for(var t=0;t<i._LOADED_LANGS.length;t++){if(i._LOADED_LANGS[t]==e){return true}}return false},isValid:function(){return i._ACTIVE_LANG&&typeof i._LANG[i._ACTIVE_LANG]=="object"}};var s={baseEditorMarkup:function(){return e("#gollum-editor").length&&e("#gollum-editor-body").length},collapsibleInputs:function(){return e("#gollum-editor .collapsed, #gollum-editor .expanded").length},formatSelector:function(){return e("#gollum-editor-format-selector select").length},functionBar:function(){return n.HasFunctionBar&&e("#gollum-editor-function-bar").length},ff4Environment:function(){var e=new RegExp(/Firefox\/4.0b/);return e.test(navigator.userAgent)},editSummaryMarkup:function(){return e("input#gollum-editor-message-field").length>0},help:function(){return e("#gollum-editor #gollum-editor-help").length&&e("#gollum-editor #function-help").length},previewButton:function(){return e("#gollum-editor #gollum-editor-preview").length},titleDisplayed:function(){return n.NewFile}};var o={isActive:false,activate:function(){r("Activating function bar");e("#gollum-editor-function-bar a.function-button").each(function(){if(i.getDefinitionFor(e(this).attr("id"))){e(this).click(o.evtFunctionButtonClick);e(this).removeClass("disabled")}else if(e(this).attr("id")!="function-help"){e(this).addClass("disabled")}});e("#gollum-editor-function-bar").addClass("active");o.isActive=true},deactivate:function(){e("#gollum-editor-function-bar a.function-button").unbind("click");e("#gollum-editor-function-bar").removeClass("active");o.isActive=false},evtFunctionButtonClick:function(t){t.preventDefault();var n=i.getDefinitionFor(e(this).attr("id"));if(typeof n=="object"){o.executeAction(n)}},executeAction:function(t){var n=e("#gollum-editor-body").val();var i=o.getFieldSelectionPosition(e("#gollum-editor-body"));var s=o.getFieldSelection(e("#gollum-editor-body"));var u=s;var a=true;var f=null;if(t.exec&&typeof t.exec=="function"){t.exec(n,s,e("#gollum-editor-body"));return}var l=/([^\n]+)/gi;if(t.search&&typeof t.search=="object"){r("Replacing search Regex");l=null;l=new RegExp(t.search);r(l)}r("repText is "+'"'+u+'"');if(t.replace&&typeof t.replace=="string"){r("Running replacement - using "+t.replace);var c=t.replace;u=u.replace(l,c);u=u.replace(/\$[\d]/g,"");if(u===""){r("Search string is empty");f=c.indexOf("$1");u=c.replace(/\$[\d]/g,"");if(f==-1){f=Math.floor(c.length/2)}}}if(t.append&&typeof t.append=="string"){if(u==s){a=false}u+=t.append}if(u){o.replaceFieldSelection(e("#gollum-editor-body"),u,a,f)}},getFieldSelectionPosition:function(e){if(e.length){var t=0,n=0;var i=e.get(0);if(typeof i.selectionStart=="number"&&typeof i.selectionEnd=="number"){t=i.selectionStart;n=i.selectionEnd}else{var s=document.selection.createRange();var o=s.duplicate();o.moveToElementText(i);o.setEndPoint("EndToEnd",s);t=o.text.length-s.text.length;n=t+s.text.length;var u=t;var a=0;var f;r("IE: start position is currently "+u);for(f=0;f<u;f++){if(i.value.charAt(f).match(/\r/)){++a}}if(a){r("IE start: compensating for "+a+" line breaks");t=t-a;a=0}var l=n;for(f=0;f<l;f++){if(i.value.charAt(f).match(/\r/)){++a}}if(a){r("IE end: compensating for "+a+" line breaks");n=n-a}}return{start:t,end:n}}},getFieldSelection:function(e){var t="";var n;if(e.length){n=o.getFieldSelectionPosition(e);t=e.val().substring(n.start,n.end);r("Selected: "+t+" ("+n.start+", "+n.end+")");return t}return false},isShown:function(){return e("#gollum-editor-function-bar").is(":visible")},refresh:function(){if(s.functionBar()){r("Refreshing function bar");if(i.isValid()){e("#gollum-editor-function-bar a.function-button").unbind("click");o.activate();if(a){a.setActiveHelp(i.getActiveLanguage())}}else{r("Language definition is invalid.");if(o.isShown()){o.deactivate()}if(a.isShown()){a.hide()}}}},replaceFieldSelection:function(e,t,n,r){var i=o.getFieldSelectionPosition(e);var s=e.val();var u=true;if(n===false){u=false}var a=null;if(e[0].scrollTop){a=e[0].scrollTop}e.val(s.substring(0,i.start)+t+s.substring(i.end));e[0].focus();if(u){if(e[0].setSelectionRange){if(r){e[0].setSelectionRange(i.start+r,i.start+r)}else{e[0].setSelectionRange(i.start,i.start+t.length)}}else if(e[0].createTextRange){var f=e[0].createTextRange();f.collapse(true);if(r){f.moveEnd(i.start+r);f.moveStart(i.start+r)}else{f.moveEnd("character",i.start+t.length);f.moveStart("character",i.start)}f.select()}}if(a){e[0].scrollTop=a}}};var u={$_SELECTOR:null,evtChangeFormat:function(t){var n=e(this).val();u.updateCommitMessage(n);i.setActiveLanguage(n)},updateCommitMessage:function(e){var t=document.getElementById("gollum-editor-message-field");var n=t.value;if(/^(?:created|updated)/i.test(n)){t.value=n.replace(/\([^\)]*\)$/,"("+e+")")}},init:function(e){r("Initializing format selector");if(u.$_SELECTOR&&typeof u.$_SELECTOR=="object"){u.$_SELECTOR.unbind("change")}u.$_SELECTOR=e;u.updateSelected();u.$_SELECTOR.change(u.evtChangeFormat)},updateSelected:function(){var e=i.getActiveLanguage();u.$_SELECTOR.val(e)}};var a={_ACTIVE_HELP:"",_LOADED_HELP_LANGS:[],_HELP:{},define:function(t,n){if(a.isValidHelpFormat(n)){r("help is a valid format");a._ACTIVE_HELP_LANG=t;a._LOADED_HELP_LANGS.push(t);a._HELP[t]=n;if(e("#function-help").length){if(e("#function-help").hasClass("disabled")){e("#function-help").removeClass("disabled")}e("#function-help").unbind("click");e("#function-help").click(a.evtHelpButtonClick);a.generateHelpMenuFor(t);if(e("#gollum-editor-help").length&&typeof e("#gollum-editor-help").attr("data-autodisplay")!=="undefined"&&e("#gollum-editor-help").attr("data-autodisplay")==="true"){a.show()}}}else{if(e("#function-help").length){e("#function-help").addClass("disabled")}}},generateHelpMenuFor:function(t){if(!a._HELP[t]){r("Help is not defined for "+t.toString());return false}var n=a._HELP[t];e("#gollum-editor-help-parent").html("");e("#gollum-editor-help-list").html("");e("#gollum-editor-help-content").html("");for(var i=0;i<n.length;i++){if(typeof n[i]!="object"){break}var s=e('<li><a href="#" rel="'+i+'">'+n[i].menuName+"</a></li>");e("#gollum-editor-help-parent").append(s);if(i===0){s.children("a").addClass("selected")}s.children("a").click(a.evtParentMenuClick)}a.generateSubMenu(n[0],0);e(e("#gollum-editor-help-list li a").get(0)).click()},generateSubMenu:function(t,n){e("#gollum-editor-help-list").html("");e("#gollum-editor-help-content").html("");for(var r=0;r<t.content.length;r++){if(typeof t.content[r]!="object"){break}var i=e('<li><a href="#" rel="'+n+":"+r+'">'+t.content[r].menuName+"</a></li>");e("#gollum-editor-help-list").append(i);i.children("a").click(a.evtSubMenuClick)}},hide:function(){if(e.browser.msie){e("#gollum-editor-help").css("display","none")}else{e("#gollum-editor-help").animate({opacity:0},200,function(){e("#gollum-editor-help").animate({height:"hide"},200)})}},show:function(){if(e.browser.msie){e("#gollum-editor-help").css("display","block")}else{e("#gollum-editor-help").animate({height:"show"},200,function(){e("#gollum-editor-help").animate({opacity:1},300)})}},showHelpFor:function(t,n){var r=a._HELP[a._ACTIVE_HELP_LANG][t].content[n].data;e("#gollum-editor-help-content").html(r)},isLoadedFor:function(e){for(var t=0;t<a._LOADED_HELP_LANGS.length;t++){if(e==a._LOADED_HELP_LANGS[t]){return true}}return false},isShown:function(){return e("#gollum-editor-help").is(":visible")},isValidHelpFormat:function(e){return typeof e=="object"&&e.length&&typeof e[0].menuName=="string"&&typeof e[0].content=="object"&&e[0].content.length},setActiveHelp:function(t){if(!a.isLoadedFor(t)){if(e("#function-help").length){e("#function-help").addClass("disabled")}if(a.isShown()){a.hide()}}else{a._ACTIVE_HELP_LANG=t;if(e("#function-help").length){if(e("#function-help").hasClass("disabled")){e("#function-help").removeClass("disabled")}e("#function-help").unbind("click");e("#function-help").click(a.evtHelpButtonClick);a.generateHelpMenuFor(t)}}},evtHelpButtonClick:function(t){t.preventDefault();if(a.isShown()){if(e("#gollum-editor-help").length&&e("#gollum-editor-help").attr("data-autodisplay")!=="undefined"&&e("#gollum-editor-help").attr("data-autodisplay")==="true"){e.post("/wiki/help?_method=delete");e("#gollum-editor-help").attr("data-autodisplay","")}a.hide()}else{a.show()}},evtParentMenuClick:function(t){t.preventDefault();if(e(this).hasClass("selected")){return}var n=e(this).attr("rel");var r=a._HELP[a._ACTIVE_HELP_LANG][n];e("#gollum-editor-help-parent li a").removeClass("selected");e(this).addClass("selected");a.generateSubMenu(r,n);e(e("#gollum-editor-help-list li a").get(0)).click()},evtSubMenuClick:function(t){t.preventDefault();if(e(this).hasClass("selected")){return}var n=e(this).attr("rel").split(":");e("#gollum-editor-help-list li a").removeClass("selected");e(this).addClass("selected");a.showHelpFor(n[0],n[1])}};e.GollumEditor.defineHelp=a.define;e.GollumEditor.Dialog=e.GollumDialog;e.GollumEditor.replaceSelection=function(t){o.replaceFieldSelection(e("#gollum-editor-body"),t)};e.GollumEditor.Placeholder=e.GollumPlaceholder})(jQuery)