module GollumRails

  # Setup functionality for Rails initializer
  #  
  # will be generated by Rails generator: `rails g gollum_rails:install`
  #
  # manually:
  #
  #   GollumRails::Setup.build do |config|
  #     config.repository = '<path_to_your_repository>'
  #     config.wiki = :default
  #     config.startup
  #   end
  #
  #
  class Setup
    class << self
      
      attr_accessor :wiki_path
      
      attr_writer :wiki_options

      attr_accessor :repository
      
      attr_accessor :startup
      
      # Gets / Sets the init options
      attr_accessor :options
      
      
      def wiki_options
        return {} unless @wiki_options.kind_of? Hash
        @wiki_options ||= {} 
      end
      # Wiki startup options
      def options=(options)
        @options = options
      end
      
      # defines block builder for Rails initializer.
      # executes public methods inside own class
      #
      def build(&block)
        block.call self
        if @repository == :application
          raise GollumRailsSetupError, "Rails configuration is not defined. 
          Are you in a Rails app?" if Rails.application.nil?
          
          initialize_wiki Rails.application.config.wiki_repository
        else
          raise GollumRailsSetupError, "Git repository does not exist.
          Was the specified pathname correct?" unless Pathname.new(@repository).exist?
          initialize_wiki @repository
        end
      end

      #######
      private
      #######

      # Checks if provided path is present and valid
      #
      # Example
      #   path_valid? '/'
      #   # =>true
      #  
      #   path_valid? nil
      #   # =>false
      def path_valid?(path)
        return path.exist? if path.is_a?(Pathname)
        return !(path.nil? || path.empty? || ! path.is_a?(String))
      end

      def initialize_wiki(path)
        if path_valid? path
          @wiki_path = path.to_s
          @wiki_options = options
          true
        else
          raise GollumRailsSetupError, 'Repistory path is empty or invalid!'
        end

      end

    end
  end
  class GollumRailsSetupError < ArgumentError; end
end
